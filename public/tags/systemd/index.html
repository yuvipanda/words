<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="systemd" />
<meta property="og:description" content="[JupyterHub](https://github.com/jupyterhub/jupyterhub) | [MyBinder](https://mybinder.org) | [Kubernetes](https://k8s.io) | Open Culture" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://words.yuvi.in/tags/systemd/" />
<meta property="og:updated_time" content="2017-03-31T23:23:52-07:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="systemd"/>
<meta name="twitter:description" content="[JupyterHub](https://github.com/jupyterhub/jupyterhub) | [MyBinder](https://mybinder.org) | [Kubernetes](https://k8s.io) | Open Culture"/>
<meta name="generator" content="Hugo 0.70.0" />


    
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Blog",
  "headline": "Yuvi Panda",
  "url" : "http:\/\/words.yuvi.in\/tags\/systemd\/",
  "author": {
    "@type": "Person",
    "name": ""
  },
  "dateModified": "2017-03-31T23:23:52-07:00",
  "keywords": "books,class-notes,code,devlog,education,events,jupyter,kubernetes,links,lol-culture,papers,personal,project-ideas,retrospective,so-called-it,uncategorized,wiki,work-plan,algorithm,android,anniversary,answers,athiesm,atleast-not-yet,bigco,bigotry,binder,blogging,book,code,crime,democratizing-programming,devlog,devlog-dec-2011,education,external-enforcement,fiction,flipkart,india,interview,it,js,learning,link,linux,note-to-future-self,opensource,parenting,personal,photo,photography,php,python,rant,reddit,reprint,resistance,review,rights,sick,sriram,systemd,talk,talks,travel,twitter,wordpress,work,yahoo,",
  "description": "[JupyterHub](https:\/\/github.com\/jupyterhub\/jupyterhub) | [MyBinder](https:\/\/mybinder.org) | [Kubernetes](https:\/\/k8s.io) | Open Culture"
}
</script>


    <link rel="canonical" href="http://words.yuvi.in/tags/systemd/">

    <title>Yuvi Panda</title>

    <!-- combined, minified CSS -->
    <link href="http://words.yuvi.in/css/style.css" rel="stylesheet" integrity="sha384-O8wjsnz02XiyrPxnhfF6AVOv6YLBaEGRCnVF&#43;DL3gCPBy9cieyHcpixIrVyD2JS5" crossorigin="anonymous">

    
    <!-- RSS 2.0 feed -->
    <link href="http://words.yuvi.in/tags/systemd/index.xml" rel="alternate" type="application/rss+xml" title="Yuvi Panda" />
    

    

    

    

  </head>

  <body>

    <div class="blog-masthead">
    
    </div>

    <header class="blog-header">
      <div class="container">
        <h1 class="blog-title">
            
            <img src='/profile.jpg' width=80 style="border-radius: 50%; margin-bottom: 12px;">
            <a href="http://words.yuvi.in/" rel="home">Yuvi Panda</a></h1>
        <p class="lead blog-description"><a href="https://github.com/jupyterhub/jupyterhub">JupyterHub</a> | <a href="https://mybinder.org">MyBinder</a> | <a href="https://k8s.io">Kubernetes</a> | Open Culture</p>
      </div>
    </header>

    <div class="container">
      <div class="row">
        <div class="col-sm-8 blog-main">

          







<article class="blog-post">
  <header>
    <h2 class="blog-post-title"><a href="http://words.yuvi.in/post/systemd-simple-containment/">systemd simple containment for GUI applications &amp; shells</a></h2>
    <p class="blog-post-meta"><time datetime="2017-03-31T23:23:52-07:00">Fri Mar 31, 2017</time> by  in 

<i class="fa fa-tag" aria-hidden="true"></i>&nbsp;<a href="/tags/systemd" rel="tag">systemd</a>, <a href="/tags/learning" rel="tag">learning</a>, <a href="/tags/code" rel="tag">code</a>

</p>
  </header>
  <p>I earlier had <a href="http://words.yuvi.in/post/systemd-gui-applications/">a vaguely working setup</a> for making sure browsers, shells and other applications don&rsquo;t eat all RAM / CPU on my machine with systemd + sudo + shell scripts.</p>
<p>It was a hacky solution, and also had complications when used to launch shells. It wasn&rsquo;t passing in all the environment varialbes it should, causing interesting-to-debug issues. <code>sudo</code> rules were complex, and hard to do securely.</p>
<p>I had also been looking for an excuse to learn more Golang, so I ended up writing <a href="https://github.com/yuvipanda/systemd-simple-containment"><code>systemd-simple-containment</code></a> or <code>ssc</code>.</p>
<p>It&rsquo;s a simple golang application that produces a binary that can be <a href="https://en.wikipedia.org/wiki/Setuid"><code>setuid</code></a> to <code>root</code>, and thus get around all our <code>sudo</code> complexity, at the price of having to be very, very careful about the code. Fortunately, it&rsquo;s short enough (~100 lines) and <code>systemd-run</code> helps it keep the following invariants:</p>
<ol>
<li>It will never spawn any executable as any user other than the &lsquo;real&rsquo; uid / gid of the user calling the binary.</li>
<li>It doesn&rsquo;t allow arbitrary systemd <code>properties</code> to be set, ensuring a more limited attack surface.</li>
</ol>
<p>However, this is the first time I&rsquo;m playing with setuid and with Go, so I probably fucked something up. I feel ok enough about my understanding of real and effective uids for now to use it myself, but not to recommend it to other people. Hopefully I&rsquo;ll be confident enough say that soon :)</p>
<p>By using a real programming language, I also easily get commandline flags for sharing tty or not (so I can use the same program for launching GUI &amp; interactive terminal applications), pass all environment variables through (which can&rsquo;t be just standard child inheritence, since <code>systemd-run</code> doesn&rsquo;t work that way) &amp; the ability to setuid (you can&rsquo;t do that easily to a script).</p>
<p>I was sure I&rsquo;d hate writing go because of the constant <code>if err != nil</code> checks, but it hasn&rsquo;t bothered me that much. I would like to write more Go, to get a better feel for it. This code is too short to like a language, but I definitely hate it less :)</p>
<p>Anyway, now I can launch GUI applications with <code>ssc -tty=false -isolation=strict firefox</code> and it does the right thing. I currently have available <code>-isolation=strict</code> and <code>-isolation=relaxed</code>, the former performing stronger sandboxing (NoNewPrivileges, PrivateTmp) than the latter (just MemoryMax). i&rsquo;ll slowly add more protections here, but just keep two modes (ideally).</p>
<p>My Gnome Terminal shell command is now <code>ssc -isolation=relaxed /bin/bash -i</code> and it works great :)</p>
<p>I am pretty happy with <code>ssc</code> as it exists now. Only thing I now want to do is to be able to use it from the GNOME launcher (I am using GNOME3 with gnome-shell). Apparently <em>shortcuts</em> are no longer cool and hence pretty hard to create in modern desktop environments :| I shall keep digging!</p>

</article> 






<article class="blog-post">
  <header>
    <h2 class="blog-post-title"><a href="http://words.yuvi.in/post/systemd-gui-applications/">systemd gui applications</a></h2>
    <p class="blog-post-meta"><time datetime="2017-03-29T20:47:10-07:00">Wed Mar 29, 2017</time> by  in 

<i class="fa fa-tag" aria-hidden="true"></i>&nbsp;<a href="/tags/systemd" rel="tag">systemd</a>, <a href="/tags/learning" rel="tag">learning</a>, <a href="/tags/code" rel="tag">code</a>

</p>
  </header>
  <p><strong>Update</strong>: There&rsquo;s a <a href="//words.yuvi.in/post/systemd-simple-containment/">follow-up post</a> with a simpler solution now.</p>
<p>Ever since I read <a href="https://blog.jessfraz.com">Jessie Frazelle</a>&lsquo;s amazing setup (<a href="https://blog.jessfraz.com/post/ultimate-linux-on-the-desktop/">1</a>, <a href="https://blog.jessfraz.com/post/docker-containers-on-the-desktop/">2</a>, <a href="https://blog.jessfraz.com/post/runc-containers-on-the-desktop/">3</a>) for running GUI applications in docker containers, I&rsquo;ve wanted to do something similar. However, I want to install things on my computer - not in docker images. So what I wanted was just isolation (no more Chrome / Firefox freezing my laptop), not images. I&rsquo;m also not as awesome (or knowledgeable!) as Jess, so will have to naturally settle for less&hellip;</p>
<p>So I am doing it in systemd!</p>
<p>Before proceeding, I want to warn y&rsquo;all that I don&rsquo;t entirely know what I am doing. Don&rsquo;t take any of this as security advice, since I don&rsquo;t entirely understand X&rsquo;s security model. Works fine for me though!</p>
<h2 id="gui-applications-">GUI applications</h2>
<p>I started out using a simple systemd <a href="https://fedoramagazine.org/systemd-template-unit-files/">templated service</a> to launch GUI applications, but soon realized that <a href="https://www.freedesktop.org/software/systemd/man/systemd-run.html">systemd-run</a> is probably the better way. So I&rsquo;ve a simple script, <code>/usr/local/bin/safeapp</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>exec sudo systemd-run  <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -p CPUQuota<span style="color:#f92672">=</span>100% <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -p MemoryMax<span style="color:#f92672">=</span>70% <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -p WorkingDirectory<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -p PrivateTmp<span style="color:#f92672">=</span>yes <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -p NoNewPrivileges<span style="color:#f92672">=</span>yes <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --setenv DISPLAY<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>DISPLAY<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --setenv DBUS_SESSION_BUS_ADDRESS<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>DBUS_SESSION_BUS_ADDRESS<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --uid <span style="color:#e6db74">${</span>USER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --gid <span style="color:#e6db74">${</span>USER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --quiet <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
</code></pre></div><p>I can run <code>safeapp /opt/firefox/firefox</code> now and it&rsquo;ll start firefox inside a nice systemd unit with a 70% Memory usage cap and CPU usage of at most 1 CPU. There&rsquo;s also other minimal security stuff applied - <code>NoNewPrivileges</code> being the most important one. I want to get <code>ProtectSystem</code> + <code>ReadWriteDirectories</code> going too, but there seems to be a bug in <code>systemd-run</code> that doesn&rsquo;t let it parse <code>ProtectSystem</code> properly&hellip;</p>
<p>Also, there&rsquo;s <a href="https://github.com/systemd/systemd/issues/3851">an annoying bug</a> in systemd v231 (which is what my current system has) - you can&rsquo;t set <code>CPUQuotas</code> over 100% (aka &gt; 1 CPU core). This is annoying if you want to give each application 3 of your 4 cores (which is what I want). Next version of Ubuntu has v232, so my GUI applications will just have to do with an aggregate of 1 full core until then.</p>
<p>The two environment variables seem to be all that&rsquo;s necessary for X applications to work.</p>
<p>And yes, this might ask you for your password. I&rsquo;ll clean this up into a nice non-bash script hopefully soon, and make all of these better.</p>
<p>Anyway, <em>it works</em>! I can now open sketchy websites with scroll hijacking without fear it&rsquo;ll kill my machine!</p>
<h2 id="cli-">CLI</h2>
<p>I wanted each tab in my terminal to be its own systemd service, so they all get equitable amount of  CPU time &amp; can&rsquo;t crash machine by themselves with OOM.</p>
<p>So I&rsquo;ve this script as <code>/usr/local/bin/safeshell</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#e6db74">`</span><span style="color:#75715e">#!/bin/bash</span>
exec sudo systemd-run <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -p CPUQuota<span style="color:#f92672">=</span>100% <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -p MemoryMax<span style="color:#f92672">=</span>70% <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -p WorkingDirectory<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --uid yuvipanda <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --gid yuvipanda <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --quiet <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --tty <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /bin/bash -i
</code></pre></div><p>The <code>--tty</code> is magic here, and does the right things wrt passing the tty that GNOME terminal is passing in all the way to the shell. Now, my login command (set under profile preferences &gt; command in gnome-terminal) is <code>sudo /usr/local/bin/safeshell</code>. In addition, I add the following line to <code>/etc/sudoers</code>:</p>
<pre><code>%sudo ALL = (root) NOPASSWD:SETENV: /usr/local/bin/safeshell
</code></pre><p>This + just specifying the username directly in <code>safeshell</code> are both hacks that make me cringe a little. I need to either fully understand how sudo&rsquo;s <code>-E</code> works, or use this as an opportunity to learn more Go and make a setuid binary.</p>
<h2 id="to-do-">To do</h2>
<p>[ ] Generalize this to not need hacks (either with better sudo usage or a setuid binary)
[ ] Investigate adding more security related options.
[ ] Make these work with desktop / dock icons.</p>
<p>I&rsquo;d normally have just never written this post, on account of &lsquo;oh no, it is imperfect&rsquo; or something like that. However, that also seems to have come in the way of ability to find joy in learning simple things :D So I shall follow <a href="https://jvns.ca/">b0rk</a>&lsquo;s lead in spending time <a href="http://words.yuvi.in/post/things-to-learn/">learning</a> for fun again :)</p>

</article> 








        </div> <!-- /.blog-main -->

        <aside class="col-sm-3 ml-auto blog-sidebar">
  
  <section class="sidebar-module sidebar-module-inset">
    <h4>about</h4>
    <p>I build infrastructure that helps reduce accidental complexities when using code to solve problems.</p>
  </section>
  
  <section class="sidebar-module sidebar-module-inset">
    <h4>projects</h4>
    <p><p>Primarily working on <a href="https://z2jh.jupyter.org">Zero to JupyterHub</a> and <a href="https://mybinder.org">MyBinder</a></p>
<p>See more on my <a href="https://github.com/yuvipanda">GitHub Profile</a></p>
</p>
  </section>
  
  <section class="sidebar-module sidebar-module-inset">
    <h4>work</h4>
    <p><p>I design, build &amp; operate large scale teaching infrastructure for the <a href="https://data.berkeley.edu/">Data Science Division at UC Berkeley</a>.</p>
<p>I also help run <a href="https://mybinder.org">MyBinder</a> thanks to a generous grant from the Gordon &amp; Betty Moore Foundation.</p>
</p>
  </section>
  
  <section class="sidebar-module sidebar-module-inset">
    <h4>contact</h4>
    <p><a href="mailto:yuvipanda@gmail.com">Email</a> is the best way to contact me privately.
<a href="https://twitter.com/yuvipanda">Twitter</a> is the best way to contact me publicly.</p>
  </section>
  

  
        <section class="sidebar-module">
    <h4>Recent Posts</h4>
    <ol class="list-unstyled">


<li><a href="/post/miss-blogging/">I miss blogging too</a></li>

<li><a href="/post/devlog-2018-12-26/">Devlog 2018 12 26</a></li>

<li><a href="/post/devlog-2018-12-24/">Devlog 2018 12 24</a></li>

<li><a href="/post/devlog-2018-12-23/">DevLog 2018 December 23</a></li>

<li><a href="/post/oss-in-the-cloud/">Freedoms for Open Source Software users in the Cloud</a></li>

    </ol>
  </section>

  

  
</aside>


      </div> <!-- /.row -->
    </div> <!-- /.container -->

    <footer class="blog-footer">
      <p>
      
      Blog template created by <a href="https://twitter.com/mdo">@mdo</a>, ported to Hugo by <a href='https://twitter.com/mralanorth'>@mralanorth</a>.
      
      </p>
      <p>
      <a href="#">Back to top</a>
      </p>
    </footer>

  </body>

</html>
