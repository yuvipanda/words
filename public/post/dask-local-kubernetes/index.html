<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Run dask-kubernetes clusters on a cloud from your Laptop - Yuvi Panda</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Yuvi Panda" /><meta name="description" content="Access dask-kubernetes clusters in the cloud from your local machine" /><meta name="keywords" content="yuvi, yuvipanda" />






<meta name="generator" content="Hugo 0.70.0 with theme even" />


<link rel="canonical" href="http://words.yuvi.in/post/dask-local-kubernetes/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.78f8f17bab244b9ee62ad16480c9584d5fc2db06ae20681d1ca225cefd80767c.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Run dask-kubernetes clusters on a cloud from your Laptop" />
<meta property="og:description" content="Access dask-kubernetes clusters in the cloud from your local machine" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://words.yuvi.in/post/dask-local-kubernetes/" />
<meta property="article:published_time" content="2020-06-27T13:27:49+05:30" />
<meta property="article:modified_time" content="2020-06-27T13:27:49+05:30" />
<meta itemprop="name" content="Run dask-kubernetes clusters on a cloud from your Laptop">
<meta itemprop="description" content="Access dask-kubernetes clusters in the cloud from your local machine">
<meta itemprop="datePublished" content="2020-06-27T13:27:49&#43;05:30" />
<meta itemprop="dateModified" content="2020-06-27T13:27:49&#43;05:30" />
<meta itemprop="wordCount" content="811">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Run dask-kubernetes clusters on a cloud from your Laptop"/>
<meta name="twitter:description" content="Access dask-kubernetes clusters in the cloud from your local machine"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Yuvi Panda</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="https://github.com/yuvipanda">
        <li class="mobile-menu-item">GitHub</li>
      </a><a href="https://twitter.com/yuvipanda">
        <li class="mobile-menu-item">Twitter</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Yuvi Panda</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="https://github.com/yuvipanda">GitHub</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://twitter.com/yuvipanda">Twitter</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Run dask-kubernetes clusters on a cloud from your Laptop</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-06-27 </span>
        <div class="post-category">
            <a href="/categories/code/"> code </a>
            <a href="/categories/dask/"> dask </a>
            </div>
          <span class="more-meta"> 811 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#credit">Credit</a></li>
    <li><a href="#create--setup-a-kubernetes-cluster">Create &amp; setup a Kubernetes cluster</a></li>
    <li><a href="#install--run-kubefwd">Install &amp; run kubefwd</a></li>
    <li><a href="#install-libraries-well-need">Install libraries we&rsquo;ll need</a></li>
    <li><a href="#setup-dask-kubernetes-configuration">Setup dask-kubernetes configuration</a></li>
    <li><a href="#create-a-remote-cluster--connect-to-it">Create a remote cluster &amp; connect to it</a></li>
    <li><a href="#create-some-workers">Create some workers</a></li>
    <li><a href="#run-some-computation">Run some computation!</a></li>
    <li><a href="#cleanup-dask-cluster">Cleanup dask cluster</a></li>
    <li><a href="#next-steps">Next steps?</a>
      <ul>
        <li><a href="#ephemeral-kuberentes-clusters">Ephemeral Kuberentes Clusters</a></li>
        <li><a href="#remove-kubefwd">Remove kubefwd</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>You can run your Jupyter Notebook locally, and connect easily to a remote <code>dask-kubernetes</code> cluster
on a cloud-based Kubernetes Cluster with the help of <a href="https://kubefwd.com/">kubefwd</a>. This notebook
will show you an example of how to do so. While this example is a Jupyter Notebook, the code will work
any local python medium - REPL, IDE (vscode), or just plain ol&rsquo; <code>.py</code> files</p>
<p>Latest executable version of this notebook can be found in <a href="https://github.com/yuvipanda/cloud-local-dask-kubernetes">this repository</a></p>
<h2 id="credit">Credit</h2>
<p>This work was sponsored by <a href="https://www.quansight.com/">Quansight</a> ❤️</p>
<h2 id="create--setup-a-kubernetes-cluster">Create &amp; setup a Kubernetes cluster</h2>
<p>You need to have a working kubernetes cluster that is configured correctly. If you can get
<code>kubectl get ns</code> to work properly, it means your cluster is working fine &amp; connected for
this to go.</p>
<h2 id="install--run-kubefwd">Install &amp; run kubefwd</h2>
<p><code>kubefwd</code> lets you access services in your cloud Kubernetes cluster as if they were
localy, with a clever combination of ol&rsquo; school <code>/etc/hosts</code> hacks &amp; fancy kubernetes
port-forwarding. It requires root on Mac OS &amp; Linux, and should theoretically work on
Windows too (haven&rsquo;t tested).</p>
<p>Once you have installed it, run it in a separate terminal.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sudo kubefwd svc -n default -n kube-system
</code></pre></td></tr></table>
</div>
</div><p>If you&rsquo;ve created your own namespace for your cluster, use that instead of <code>default</code>.
The <code>kube-system</code> is required until <a href="https://github.com/txn2/kubefwd/issues/132">this issue</a>
is fixed.</p>
<p>If the <code>kubefwd</code> command runs successfully, we&rsquo;re good to go!</p>
<h2 id="install-libraries-well-need">Install libraries we&rsquo;ll need</h2>
<p>In addition to <code>dask-kubernetes</code>, we&rsquo;ll also need <code>numpy</code> to test our cluster with dask arrays.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="n">numpy</span> <span class="n">dask</span> <span class="n">distributed</span> <span class="n">dask</span><span class="o">-</span><span class="n">kubernetes</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="setup-dask-kubernetes-configuration">Setup dask-kubernetes configuration</h2>
<p>Normally, the pod template would come from an external configuration file.
We keep this in the notebook to make it more self contained.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">POD_SPEC</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;Pod&#39;</span><span class="p">,</span>
    <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;restartPolicy&#39;</span><span class="p">:</span> <span class="s1">&#39;Never&#39;</span><span class="p">,</span>
        <span class="s1">&#39;containers&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="s1">&#39;daskdev/dask:latest&#39;</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;dask-worker&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;--death-timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;60&#39;</span>
                <span class="p">],</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;dask&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="create-a-remote-cluster--connect-to-it">Create a remote cluster &amp; connect to it</h2>
<p>We create a <code>KubeCluster</code> object, with <code>deploymode='remote'</code>. This creates
the scheduler as a pod on the cluster, so worker &lt;-&gt; scheduler communication
is easy &amp; efficient. <code>kubefwd</code> helps us communicate to this remote scheduler,
so we can pretend we are actually on the remote cluster.</p>
<p>If you are using <code>kubectl</code> to watch the objects created in your namespace,
you&rsquo;ll see a <code>service</code> and a <code>pod</code> created for this. <code>kubefwd</code> should
also list a log line about forwarding the service port locally.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">dask_kubernetes</span> <span class="kn">import</span> <span class="n">KubeCluster</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="n">KubeCluster</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">POD_SPEC</span><span class="p">,</span> <span class="n">deploy_mode</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="create-some-workers">Create some workers</h2>
<p>We have a scheduler in the cloud, now time to create some workers in the
cloud! We create 2, and can watch the worker pods come up with glee in
<code>kubectl</code></p>
<p>All scaling methods (adaptive scaling, using the widget, etc) should work
here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="run-some-computation">Run some computation!</h2>
<p>We test our cluster by doing some trivial calculations with dask arrays.
You can use any dask code as you normally would here, and it would
run on the cloud Kubernetes cluster. This is especially helpful if you
have large amounts of data in the cloud, since the workers would be
really close to where the data is.</p>
<p>You might get warnings about version mismatches. This is ok for the demo,
in production you&rsquo;d probably build your own docker image that will
have fixed versions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="kn">as</span> <span class="nn">da</span>

<span class="c1"># Connect Dask to the cluster</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

<span class="c1"># Create a large array and calculate the mean</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>  <span class="c1"># Should print 1.0</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="cleanup-dask-cluster">Cleanup dask cluster</h2>
<p>When you&rsquo;re done with your cluster, remember to clean it up to release
the resources!</p>
<p>This doesn&rsquo;t affect your kubernetes cluster itself - you&rsquo;ll need to
clean that up manually</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="next-steps">Next steps?</h2>
<p>Lots more we can do from here.</p>
<h3 id="ephemeral-kuberentes-clusters">Ephemeral Kuberentes Clusters</h3>
<p>We can wrap kubernetes cluster creation in some nice python functions, letting users create kubernetes clusters just-in-time for running a dask-kubernetes cluster, and tearing it down when they&rsquo;re done. Users can thus &lsquo;bring their own compute&rsquo; - since the clusters will be in their cloud accounts - without having the complication of understanding how the cloud works. This is where this would be different from the wonderful <a href="https://gateway.dask.org">dask-gateway</a> project I think.</p>
<h3 id="remove-kubefwd">Remove kubefwd</h3>
<p><code>kubefwd</code> isn&rsquo;t strictly necessary, and should ideally be replaced by a <code>kubectl port-forward</code> call that doesn&rsquo;t require root. This should be possible with some changes to the <code>dask-kubernetes</code> code, so the client can connect to the scheduler via a different address (say, <code>localhost:8974</code>, since that&rsquo;s what <code>kubectl port-forward</code> gives us) vs the workers (which need something like <code>dask-cluster-scheduler-c12.namespace:8786</code>, since that is in-cluster address).</p>
<p>Longer term, it would be great if we can get rid of spawning other processes altogether, if/when the python kubernetes client gains the <a href="https://github.com/kubernetes-client/python/issues/166">ability to port-forward</a>.</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Yuvi Panda</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2020-06-27
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        
        <a class="next" href="/post/google-domain/">
            <span class="next-text nav-default">Check if an organization is using GSuite</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'yuvipanda';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://localhost:1313" class="iconfont icon--pocket" title="-pocket"></a>
      <a href="mailto:yuvipanda@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/yuvipanda" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/yuvipanda" class="iconfont icon-github" title="github"></a>
  <a href="http://words.yuvi.in/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2005 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Yuvi Panda</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-110578237-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
